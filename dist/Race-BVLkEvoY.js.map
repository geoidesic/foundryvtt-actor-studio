{"version":3,"file":"Race-BVLkEvoY.js","sources":["../src/components/organisms/dnd5e/Tabs/Race.svelte"],"sourcesContent":["<script>\n  import SvelteSelect from \"svelte-select\";\n  import IconSelect from \"~/src/components/atoms/select/IconSelect.svelte\";\n  import StandardTabLayout from \"~/src/components/organisms/StandardTabLayout.svelte\";\n  import {\n    getFoldersFromMultiplePacks,\n    extractItemsFromPacksSync,\n    getPacksFromSettings,\n    getAdvancementValue,\n    illuminatedDescription\n  } from \"~/src/helpers/Utility.js\";\n  import { getContext, onDestroy, onMount, tick } from \"svelte\";\n  import { localize as t } from \"~/src/helpers/Utility\";\n  import { race, subRace, readOnlyTabs } from \"~/src/stores/index\";\n  import { MODULE_ID } from \"~/src/helpers/constants\";\n\n  let active = null,\n    value = null,\n    placeHolder = t('Tabs.Races.Placeholder'),\n    richHTML = \"\";\n  let packs = getPacksFromSettings(\"races\");\n  let allRaceItems = extractItemsFromPacksSync(packs, [\n    \"name->label\",\n    \"img\",\n    \"type\",\n    \"folder\",\n    \"uuid->value\",\n    \"_id\",\n  ]);\n  const showPackLabelInSelect = game.settings.get(MODULE_ID, 'showPackLabelInSelect');\n  const importPath = \"components/molecules/dnd5e/Advancements/\";\n\n  // window.GAS.log.d('allRaceItems', allRaceItems)\n  let raceDefinitions = allRaceItems\n    .filter((x) => x.type == \"race\")\n    .sort((a, b) => a.label.localeCompare(showPackLabelInSelect ? b.compoundLabel : b.label));\n\n  const actor = getContext(\"#doc\");\n  let advancementComponents = {};\n\n  async function importAdvancements(advancements) {\n    if (!advancements || !Array.isArray(advancements)) return;\n    \n    // window.GAS.log.d('advancementArray',advancements)\n    for (const advancement of advancements) {\n      try {\n        const module = await import(`~/src/components/molecules/dnd5e/Advancements/${advancement.type}.svelte`);\n        advancementComponents[advancement.type] = module.default;\n      } catch (error) {\n        window.GAS.log.e(`Failed to load component for ${advancement.type}:`, error);\n      }\n    }\n  };\n\n  async function selectRaceHandler(option) {\n    const selectedRace = await fromUuid(option);\n    $race = selectedRace;\n    active = option;\n    if(!value) {\n      value = option;\n    }\n    \n    const advancements = getAdvancements($race);\n    await importAdvancements(advancements);\n    richHTML = await illuminatedDescription(html, $race);\n\n    Hooks.call('gas.richhtmlReady', richHTML);\n  };\n\n  // Get the advancement array safely\n  function getAdvancements(race) {\n    if (!race || !race.system || !race.system.advancement) return [];\n    \n    return race.system.advancement.filter(\n      (value) => !(value.type == \"Trait\" && value.title == \"Dwarven Resilience\")\n    );\n  }\n\n  // Function to update richHTML based on current race\n  async function updateRichHTML() {\n    if ($race) {\n      const advancements = getAdvancements($race);\n      await importAdvancements(advancements);\n      richHTML = await illuminatedDescription($race.system?.description?.value || \"\", $race);\n    }\n  }\n\n  $: actorObject = $actor.toObject();\n  $: options = raceDefinitions;\n  $: html = $race?.system?.description?.value || \"\";\n  $: movement = $race?.system?.movement;\n  $: senses = $race?.system?.senses;\n  $: units = $race?.system?.movement?.units || \"\";\n  $: type = $race?.system?.type || \"\";\n  $: source = $race?.system?.source || \"\";\n  $: book = source?.book || \"\";\n  $: page = source?.page ? \", p. \" + source.page : \"\";\n  \n  // Calculate advancements\n  $: advancementArray = getAdvancements($race);\n  \n  // Make sure to update active/value when race changes to ensure display in readonly mode\n  $: if ($race && (!active || !value)) {\n    active = $race.uuid;\n    value = $race.uuid;\n    updateRichHTML();\n  }\n\n  // Also update richHTML when html changes (dependency of illuminatedDescription)\n  $: if ($race && html) {\n    updateRichHTML();\n  }\n\n  $: filteredMovement = movement\n    ? Object.keys(movement)\n        .filter((key) => key !== \"units\" && movement[key])\n        .map((key) => ({ label: key, value: movement[key] }))\n    : [];\n\n  $: filteredSenses = senses\n    ? Object.keys(senses)\n        .filter((key) => key !== \"units\" && senses[key])\n        .map((key) => ({ label: key, value: senses[key] }))\n    : [];\n\n  // Debug logs\n  // $: window.GAS.log.d(\"Race component:\", { \n  //   race: $race, \n  //   active, \n  //   value, \n  //   readOnlyTabs: $readOnlyTabs,\n  //   richHTML: richHTML ? richHTML.substring(0, 50) + \"...\" : \"\", // truncate for logging\n  //   advancementArray: advancementArray?.length || 0\n  // });\n\n  onMount(async () => {\n    // Log mount\n    // window.GAS.log.d(\"Race tab mounted\");\n    \n    let raceUuid;\n    if (window.GAS.debug) {\n      raceUuid = window.GAS.race;\n    }\n    if (raceUuid) {\n      await selectRaceHandler(raceUuid);\n    }\n    \n    // If we have a race in the store but no active selection, set the active selection\n    if ($race && (!active || !value)) {\n      window.GAS.log.d(\"Setting active/value from $race:\", $race);\n      active = $race.uuid;\n      value = $race.uuid;\n      await updateRichHTML();\n    }\n  });\n\n</script>\n\n<template lang=\"pug\">\nStandardTabLayout(title=\"{t('Tabs.Races.Title')}\" showTitle=\"{true}\" tabName=\"race\")\n  div(slot=\"left\")\n    .flexrow\n      .flex0.required(class=\"{$race ? '' : 'active'}\") *\n      .flex3 \n        IconSelect.mb-md.icon-select({options} {active} {placeHolder} groupBy=\"{['sourceBook','packLabel']}\" handler=\"{selectRaceHandler}\" id=\"race-select\" bind:value)\n    +if(\"value\")\n      +if(\"source\")\n        //- h3.left {t('Source')}\n        ol.properties-list\n          li {book} {page} {type.value ? ', ' + type.value : ''} \n\n      +if(\"filteredMovement\")\n        h2.left {t('Tabs.Races.Movement')}\n        ol.properties-list\n          +each(\"filteredMovement as movement\")\n            li.left {movement.label} : {movement.value} {units}\n      +if(\"filteredSenses.length\")\n        h2.left {t('Tabs.Races.Senses')}\n        ol.properties-list\n          +each(\"filteredSenses as senses\")\n            li.left {senses.label} : {senses.value} {units}\n      +if(\"advancementArray\")\n        h2.left {t('Advancements')}\n        ul.icon-list\n          +each(\"advancementArray as advancement\")\n            //- @todo: this should be broken out into components for each advancement.type\n            li.left\n              .flexrow(data-tooltip=\"{getAdvancementValue(advancement, 'hint')}\" data-tooltip-class=\"gas-tooltip dnd5e2 dnd5e-tooltip item-tooltip\")\n                .flex0.relative.image\n                  img.icon(src=\"{advancement.icon}\" alt=\"{advancement.title}\")\n                .flex2 {advancement.title}\n              .flexrow\n                svelte:component(this=\"{advancementComponents[advancement.type]}\" advancement=\"{advancement}\")\n  \n  div(slot=\"right\") {@html richHTML}\n</template>\n\n<style lang=\"sass\">\n  :global(.icon-select)\n    position: relative\n</style>\n"],"names":["ctx","t","race"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;IA8J2Z,IAAM,CAAA,KAAA,kBAAA,GAAA;AAAA;;;IAAyG,IAAgB,CAAA,KAAA,kBAAA,GAAA;AAAA;AAAwM,MAAA;AAAA;AAAA,IAAA,OAAe,UAAM,kBAAA,GAAA;AAAA;;;IAA8L,IAAgB,EAAA,KAAA,kBAAA,GAAA;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;QAA1iBA,KAAM,CAAA;AAAA,QAAA;;;;;;;;;;;;;;QAAyGA,KAAgB,CAAA;AAAA,QAAA;;;;;;;;;;;;AAAwM;AAAA;AAAA,QAAAA,QAAe;AAAA,QAAM;;;;;;;;;;;;;;QAA8LA,KAAgB,EAAA;AAAA,QAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAApf,MAAA;AAAA;AAAA,IAAA,QAAK,QAAQ;AAAA,IAAO,IAAI,EAAA,EAAC,QAAQ;AAAA;;;;;;;;;QAA/C,IAAI,EAAA;AAAA,MAAA;;;;QAAG,IAAI,EAAA;AAAA,MAAA;;;;;;;AAA5C,aAA8F,QAAA,IAAA,MAAA;AAAlE,aAA6D,IAAA,EAAA;;;;;;;;;;;;;QAAxDA,KAAI,EAAA;AAAA,MAAA;;;;;QAAGA,KAAI,EAAA;AAAA,MAAA;AAAG,UAAA,MAAA,CAAA;AAAA,MAAA,QAAA,cAAA;AAAA,MAAAA,SAAK,QAAQ;AAAA,MAAOA,KAAI,EAAA,EAAC,QAAQ,IAAE,UAAA,IAAA,QAAA;AAAA;;;;;;;;;;;;;IAA0H,IAAgB,CAAA;AAAA,EAAA;;mCAArB,QAAI,KAAA,GAAA;;;;;;AAAhE,SAAA,cAAA,GAAAC,SAAE,qBAAqB,CAAA;;;;;;;;;AAAzC,aAAgD,QAAA,IAAA,MAAA;AAAA,aAA6I,QAAA,IAAA,MAAA;;;;;;;;;;;;UAA1GD,KAAgB,CAAA;AAAA,QAAA;;qCAArB,QAAI,KAAA,GAAA;;;;;;;;;;;;;0CAAJ;AAAA;;;;;;;;;;;;;AAAoD,MAAA;AAAA;AAAA,IAAA,OAAS,QAAK;AAAA;;;AAAK,MAAA;AAAA;AAAA,IAAA,OAAS,QAAK;AAAA;;;;;;;;gBAAlB,KAAG;;;;;QAAkB,IAAK,EAAA;AAAA,MAAA;;;;AAA3D,aAAiE,QAAA,IAAA,MAAA;;;;;;;;AAA/C,UAAA,MAAA,CAAA;AAAA,MAAA,OAAA,cAAA;AAAA,MAAAA,QAAS,QAAK,IAAA,UAAA,IAAA,QAAA;AAAK,UAAA,MAAA,CAAA;AAAA,MAAA,OAAA,cAAA;AAAA,MAAAA,QAAS,QAAK,IAAA,UAAA,IAAA,QAAA;;;;;QAAGA,KAAK,EAAA;AAAA,MAAA;AAAA;;;;;;;;;;;;;IAAmI,IAAc,CAAA;AAAA,EAAA;;mCAAnB,QAAI,KAAA,GAAA;;;;;;AAA9D,SAAA,cAAA,GAAAC,SAAE,mBAAmB,CAAA;;;;;;;;;AAAvC,aAA8C,QAAA,IAAA,MAAA;AAAA,aAAqI,QAAA,IAAA,MAAA;;;;;;;;;;;;UAAlGD,KAAc,CAAA;AAAA,QAAA;;qCAAnB,QAAI,KAAA,GAAA;;;;;;;;;;;;;0CAAJ;AAAA;;;;;;;;;;;;;AAAgD,MAAA;AAAA;AAAA,IAAA,OAAO,QAAK;AAAA;;;AAAK,MAAA;AAAA;AAAA,IAAA,OAAO,QAAK;AAAA;;;;;;;;gBAAhB,KAAG;;;;;QAAgB,IAAK,EAAA;AAAA,MAAA;;;;AAAvD,aAA6D,QAAA,IAAA,MAAA;;;;;;;;AAA3C,UAAA,MAAA,CAAA;AAAA,MAAA,OAAA,cAAA;AAAA,MAAAA,QAAO,QAAK,IAAA,UAAA,IAAA,QAAA;AAAK,UAAA,MAAA,CAAA;AAAA,MAAA,OAAA,cAAA;AAAA,MAAAA,QAAO,QAAK,IAAA,UAAA,IAAA,QAAA;;;;;QAAGA,KAAK,EAAA;AAAA,MAAA;AAAA;;;;;;;;;;;;;;IAAmH,IAAgB,EAAA;AAAA,EAAA;;iCAArB,QAAI,KAAA,GAAA;;;;;;;;;AAAnD,SAAA,cAAA,GAAAC,SAAE,cAAc,CAAA;;;;;;;;;AAAlC,aAAyC,QAAA,IAAA,MAAA;AAAA,aAA6hB,QAAA,IAAA,MAAA;;;;;;;;;;;;;UAAhgBD,KAAgB,EAAA;AAAA,QAAA;;mCAArB,QAAI,KAAA,GAAA;;;;;;;;;;;;;4BAAJ,QAAI,IAAA,YAAA,QAAA,KAAA,GAAA;;;;;;;;qCAAJ,QAAI,KAAA,GAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAqU,MAAA;AAAA;AAAA,IAAA,QAAY,QAAK;AAAA;;;;;;;;IAA2D,IAAqB,CAAA;AAAA;AAAA,MAAC,IAAW,EAAA,EAAC;AAAA,IAAI;AAAA;;;;;QAAkBA,KAAW,EAAA;AAAA,QAAA;AAAA;;;;;;;;;;;;;;;;AAAtN,UAAA,CAAA,cAAA,IAAA,KAAA;AAAA,MAAA,QAAY,IAAI,EAAA,MAAA,KAAA,OAAA,aAAA;AAAS,WAAA,KAAA,OAAA;AAAA,MAAA,QAAY,KAAK;;;;2DAAlN;AAAA;AAAA,QAAoB,IAAW,EAAA;AAAA,QAAE;AAAA,MAAM,CAAA;;;;;;AAA5F,aAAod,QAAA,IAAA,MAAA;AAAnc,aAAiT,IAAA,IAAA;AAA/J,aAA6G,MAAA,IAAA;AAA3E,aAAqE,MAAA,GAAA;AAAM,aAA4C,MAAA,IAAA;;AAAM,aAA6I,IAAA,IAAA;;;;;AAAlP,UAAA,CAAA,WAAA,MAAA,CAAA;AAAA,MAAA,QAAA,CAAA,cAAA,IAAA,KAAA;AAAA,MAAAA,SAAY,IAAI,GAAA;;;AAAS,UAAA,CAAA,WAAA,MAAA,CAAA;AAAA,MAAA,QAAA,mBAAA;AAAA,MAAAA,SAAY,QAAK;;;AAA6B,WAAA,CAAA,WAAA,MAAA,CAAA;AAAA,MAAA,SAAA,eAAA;AAAA,MAAAA,SAAY,QAAK,IAAA,UAAA,KAAA,SAAA;;qEAAhQ;AAAA;AAAA,QAAoBA,KAAW,EAAA;AAAA,QAAE;AAAA,MAAM,IAAA;;;;;MAAoRA,KAAqB,CAAA;AAAA;AAAA,QAACA,KAAW,EAAA,EAAC;AAAA,MAAI,IAAA;;;;;;;;;;;;;;;;;;;;;QAAkBA,KAAW,EAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAAnsC,SAAA,CAAA,cAAa,WAAW;AAAA;;MAAc,IAAiB,EAAA;AAAA;AAAA;;;;;;;;;;;;;IAA6D,IAAK,CAAA,KAAA,gBAAA,GAAA;AAAA;;;;;;iBAAtO,GAAC;;;;;OAAzB,IAAK,CAAA,IAAG,KAAK,SAAQ;;;;;;AAAvF,aAAu8C,QAAA,MAAA,MAAA;AAAt7C,aAAqS,MAAA,IAAA;AAAhR,aAA2D,MAAA,IAAA;;AAAA,aAA+M,MAAA,IAAA;;;;;;;;OAA9OA,KAAK,CAAA,IAAG,KAAK,YAAQ;;;;;;;;;;;;;;;;;;;;QAAoOA,KAAK,CAAA;AAAA,QAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAuoC,aAAwC,QAAA,KAAA,MAAA;;MAAf,IAAQ,CAAA;AAAA;;;;MAARA,KAAQ,CAAA;AAAA;;;;;;;;;;;;;MAAliD,OAAAC,SAAE,kBAAkB;AAAA,iBAAgB;AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAxFpD,SAAA,gBAAgBC,OAAI;OACtBA,SAAI,CAAKA,MAAK,WAAWA,MAAK,OAAO,YAAW,QAAA,CAAA;AAE9C,SAAAA,MAAK,OAAO,YAAY,OAC5B,WAAK,EAAO,MAAM,QAAQ,WAAW,MAAM,SAAS,qBAAoB;;;;;;;;;;;;;;;;;;AA1DzE,MAAA,SAAS,MACX,QAAQ,MACR,cAAcD,SAAE,wBAAwB,GACxC,WAAW;MACT,QAAQ,qBAAqB,OAAO;AACpC,MAAA,eAAe,0BAA0B,QAC3C,eACA,OACA,QACA,UACA,eACA,KAAK,CAAA;QAED,wBAAwB,KAAK,SAAS,IAAI,WAAW,uBAAuB;AAI9E,MAAA,kBAAkB,aACnB,OAAQ,OAAM,EAAE,QAAQ,MAAM,EAC9B,MAAM,GAAG,MAAM,EAAE,MAAM,cAAc,wBAAwB,EAAE,gBAAgB,EAAE,KAAK,CAAA;QAEnF,QAAQ,WAAW,MAAM;;MAC3B,wBAAqB,CAAA;AAEV,iBAAA,mBAAmB,cAAY;AACvC,QAAA,CAAA,gBAAY,CAAK,MAAM,QAAQ,YAAY,EAAA;AAGrC,eAAA,eAAe,cAAY;;cAE5B,SAAM,MAAA,qCAAA,uBAAA,OAAA,EAAA,wEAAA,MAAA,OAAA,uCAAA,GAAA,qDAAA,MAAA,OAAA,oBAAA,GAAA,0DAAA,MAAA,OAAA,yBAAA,GAAA,2DAAA,MAAA,OAAA,0BAAA,GAAA,0DAAA,MAAA,OAAA,yBAAA,GAAA,2DAAA,MAAA,OAAA,0BAAA,GAAA,qDAAA,MAAA,OAAA,oBAAA,GAAA,yDAAA,MAAA,OAAA,wBAAA,GAAA,sDAAA,MAAA,OAAA,qBAAA,EAAA,CAAA,GAAA,yCAAA,YAAA,IAAA,WAAA,CAAA;AACZ,qBAAA,GAAA,sBAAsB,YAAY,IAAI,IAAI,OAAO,SAAO,qBAAA;AAAA,eACjD,OAAK;AACZ,eAAO,IAAI,IAAI,EAAC,gCAAiC,YAAY,IAAI,KAAK,KAAK;AAAA;;;AAKlE,iBAAA,kBAAkB,QAAM;UAC/B,eAAY,MAAS,SAAS,MAAM;AAC1C,oBAAA,MAAA,QAAQ,cAAY,KAAA;AACpB,iBAAA,GAAA,SAAS,MAAM;SACX,OAAK;AACP,mBAAA,GAAA,QAAQ,MAAM;AAAA;UAGV,eAAe,gBAAgB,KAAK;AACpC,UAAA,mBAAmB,YAAY;AACrC,iBAAA,GAAA,WAAQ,MAAS,uBAAuB,MAAM,KAAK,CAAA;AAEnD,UAAM,KAAK,qBAAqB,QAAQ;AAAA;iBAa3B,iBAAc;QACvB,OAAK;YACD,eAAe,gBAAgB,KAAK;AACpC,YAAA,mBAAmB,YAAY;AACrC,mBAAA,GAAA,WAAQ,MAAS,uBAAuB,MAAM,QAAQ,aAAa,SAAS,IAAI,KAAK,CAAA;AAAA;;AAoDzF,UAAO,YAAA;QAID;QACA,OAAO,IAAI,OAAK;AAClB,iBAAW,OAAO,IAAI;AAAA;QAEpB,UAAQ;AACJ,YAAA,kBAAkB,QAAQ;AAAA;QAI9B,UAAK,CAAM,UAAM,CAAK,QAAK;AAC7B,aAAO,IAAI,IAAI,EAAE,oCAAoC,KAAK;sBAC1D,SAAS,MAAM,IAAI;sBACnB,QAAQ,MAAM,IAAI;YACZ,eAAc;AAAA;;;;;;;;;AAjEP,aAAO,SAAQ;AAAA;;;AAE/B,mBAAA,IAAE,OAAO,OAAO,QAAQ,aAAa,SAAS,EAAE;AAAA;;;sBAC9C,WAAW,OAAO,QAAQ,QAAQ;AAAA;;;sBAClC,SAAS,OAAO,QAAQ,MAAM;AAAA;;;AAChC,mBAAA,IAAE,QAAQ,OAAO,QAAQ,UAAU,SAAS,EAAE;AAAA;;;AAC9C,mBAAA,IAAE,OAAO,OAAO,QAAQ,QAAQ,EAAE;AAAA;;;AAClC,mBAAA,GAAE,SAAS,OAAO,QAAQ,UAAU,EAAE;AAAA;;;uBACpC,OAAO,QAAQ,QAAQ,EAAE;AAAA;;;AAC3B,mBAAA,IAAE,OAAO,QAAQ,OAAO,UAAU,OAAO,OAAO,EAAE;AAAA;;;AAGlD,mBAAA,IAAE,mBAAmB,gBAAgB,KAAK,CAAA;AAAA;;;AAG1C,UAAM,UAAK,CAAM,WAAW,QAAK;wBAChC,SAAS,MAAM,IAAI;wBACnB,QAAQ,MAAM,IAAI;AAClB,uBAAc;AAAA;;;;AAIf,UAAM,SAAS,MAAI;AAClB,uBAAc;AAAA;;;;AAGf,mBAAA,GAAE,mBAAmB,WAClB,OAAO,KAAK,QAAQ,EACjB,OAAQ,SAAQ,QAAQ,WAAW,SAAS,GAAG,CAAA,EAC/C,IAAK,UAAG,EAAQ,OAAO,KAAK,OAAO,SAAS,GAAG,IAAA;;;;AAGrD,mBAAA,GAAE,iBAAiB,SAChB,OAAO,KAAK,MAAM,EACf,OAAQ,SAAQ,QAAQ,WAAW,OAAO,GAAG,CAAA,EAC7C,IAAK,UAAG,EAAQ,OAAO,KAAK,OAAO,OAAO,GAAG,IAAA;;;AAlCnD,eAAA,IAAE,UAAU,eAAe;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}