{"version":3,"file":"Background-D4hNFPKD.js","sources":["../src/components/organisms/dnd5e/Tabs/Background.svelte"],"sourcesContent":["<script>\n  import SvelteSelect from \"svelte-select\";\n  import IconSelect from \"~/src/components/atoms/select/IconSelect.svelte\";\n  import {\n    getFoldersFromMultiplePacks,\n    extractItemsFromPacksSync,\n    getPacksFromSettings,\n    getAdvancementValue,\n    illuminatedDescription\n  } from \"~/src/helpers/Utility.js\";\n  import { getContext, onDestroy, onMount, tick } from \"svelte\";\n  import { localize as t } from \"~/src/helpers/Utility\";\n  import { background, readOnlyTabs } from \"~/src/stores/index\";\n\n  let active = null,\n    value = null,\n    placeHolder = t('Tabs.Background.Placeholder');\n  let packs = getPacksFromSettings(\"backgrounds\");\n  // let folders = getFoldersFromMultiplePacks(packs, 1);\n  // let folderIds = folders.map((x) => x._id);\n  let allItems = extractItemsFromPacksSync(packs, [\n    \"name->label\",\n    \"img\",\n    \"type\",\n    \"folder\",\n    \"uuid->value\",\n    \"_id\",\n  ]);\n  let itemDefinitions = allItems\n    .filter((x) => x.type == \"background\")\n    .sort((a, b) => a.label.localeCompare(b.label));\n  const actor = getContext(\"#doc\");\n\n  $: options = itemDefinitions;\n  $: advancementComponents = {};\n  $: html = $background?.system?.description.value || \"\";\n  $: backgrounds = allItems.filter((x) => x.type == \"background\");\n  $: advancementArray = $background?.advancement?.byId\n    ? Object.entries($background.advancement.byId).map(([id, value]) => ({\n        ...value,\n        id,\n      }))\n    : [];\n\n  let richHTML = \"\";\n\n  $: isDisabled = $readOnlyTabs.includes(\"background\");\n\n  const importAdvancements = async () => {\n    for (const advancement of advancementArray) {\n      try {\n        const module = await import(`~/src/components/molecules/dnd5e/Advancements/${advancement.type}.svelte`);\n        advancementComponents[advancement.type] = module.default;\n      } catch (error) {\n        log.e(`Failed to load component for ${advancement.type}:`, error);\n      }\n    }\n  };\n  \n  const selectBackgroundHandler = async (option) => {\n    console.log('BACKGROUND SELECTION START:', {\n        option,\n        optionType: typeof option\n    });\n\n    const selectedBackground = await fromUuid(option);\n    console.log('BACKGROUND FROM UUID:', {\n        selectedBackground,\n        properties: Object.keys(selectedBackground || {}),\n        system: selectedBackground?.system,\n        advancement: selectedBackground?.advancement\n    });\n\n    $background = selectedBackground;\n    active = option;\n    if(!value) {\n      value = option;\n    }\n    await tick();\n    await importAdvancements();\n    richHTML = await illuminatedDescription(html, $background);\n\n    Hooks.call('gas.richhtmlReady', richHTML);\n  };\n\n\n  onMount(async () => {\n    let backgroundUuid;\n    if (window.GAS.debug) {\n      backgroundUuid = window.GAS.background;\n    } else {\n      backgroundUuid = $background?.uuid;\n    }\n    if (backgroundUuid) {\n      await selectBackgroundHandler(backgroundUuid);\n    }\n  });\n\n</script>\n\n<template lang=\"pug\">\n.content\n  h1.center.mt-none.hide {t('Tabs.Background.Title')}\n  .flexrow\n    .flex2.pr-sm.col-a\n      .flexrow\n        .flex0.required(class=\"{$background ? '' : 'active'}\") *\n        .flex3 \n          IconSelect.icon-select({options} {active} {placeHolder} handler=\"{selectBackgroundHandler}\" id=\"background-select\" bind:value disabled=\"{isDisabled}\")\n     \n      +if(\"advancementArray.length\")\n        h2.left {t('Advancements')}\n        ul.icon-list\n          +each(\"advancementArray as advancement\")\n            //- @todo: this should be broken out into components for each advancement.type\n            li.left\n              .flexrow(data-tooltip=\"{getAdvancementValue(advancement, 'hint')}\"  data-tooltip-class=\"gas-tooltip dnd5e2 dnd5e-tooltip item-tooltip\")\n                .flex0.relative.image\n                  img.icon(src=\"{advancement.icon}\" alt=\"{advancement.title}\")\n                .flex2 {advancement.title}\n              .flexrow\n                //- pre advancement {advancement.type}\n                svelte:component(this=\"{advancementComponents[advancement.type]}\" advancement=\"{advancement}\")\n\n    .flex0.border-right.right-border-gradient-mask \n    .flex3.left.pl-md.scroll.col-b {@html richHTML}\n\n</template>\n\n<style lang=\"sass\">\n  @import \"../../../../../styles/Mixins.sass\"\n  .content \n    @include staticOptions\n\n    .col-a\n      // max-width: 325px\n\n  :global(.icon-select)\n    position: relative\n\n</style>\n"],"names":["t","ctx","value"],"mappings":"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"}